# VS Code 插件本地调试教程

本文档介绍如何在本地调试 `git-merge-branch-to` VS Code 扩展。

## 📋 环境要求

### 必需环境
- **Node.js**: 20.10.0（推荐使用 Volta 管理版本）
- **npm**: 9.5.1
- **VS Code**: 1.88.0 或更高版本
- **Git**: 已安装并配置

### 推荐工具
- **Volta**: Node.js 版本管理工具（项目已配置）
- **Git**: 用于测试分支合并功能

## 🚀 快速开始

### 1. 克隆项目

```bash
git clone https://github.com/FlyAboveGrass/git-merge-branch-to.git
cd git-merge-branch-to
```

### 2. 安装依赖

```bash
# 如果使用 Volta（推荐）
volta install node@20.10.0 npm@9.5.1

# 安装项目依赖
npm install
```

### 3. 代码检查

```bash
# 运行 ESLint 检查
npm run lint
```

## 🐛 调试步骤

### 方法一：使用 VS Code 调试面板（推荐）

1. **打开项目**
   - 在 VS Code 中打开项目根目录

2. **设置断点**
   - 在 `extension.js` 中需要调试的代码行左侧点击，设置断点（红色圆点）

3. **启动调试**
   - 按 `F5` 或点击左侧调试面板的 "Run Extension" 配置
   - 或者使用快捷键：
     - **Mac**: `Cmd + Shift + D` 打开调试面板，然后点击绿色播放按钮
     - **Windows/Linux**: `Ctrl + Shift + D` 打开调试面板，然后点击绿色播放按钮

4. **新窗口启动**
   - 会自动打开一个新的 VS Code 窗口（Extension Development Host）
   - 这个新窗口会加载你的扩展

5. **测试功能**
   - 在新窗口中打开一个 Git 仓库
   - 使用命令面板（`Cmd+Shift+P` 或 `Ctrl+Shift+P`）
   - 输入 "合并分支到指定分支" 或 `gitMergeBranchTo.merge-branch-to`
   - 执行命令，触发断点

6. **查看调试信息**
   - 在原始窗口中查看调试控制台输出
   - 查看变量值、调用栈等信息
   - 使用调试工具栏控制执行流程：
     - **继续** (F5): 继续执行到下一个断点
     - **单步跳过** (F10): 执行当前行，不进入函数内部
     - **单步进入** (F11): 进入函数内部
     - **单步跳出** (Shift+F11): 跳出当前函数
     - **重启** (Cmd+Shift+F5): 重新启动调试
     - **停止** (Shift+F5): 停止调试

### 方法二：使用命令行调试

```bash
# 安装 vsce（如果还没有）
npm install -g @vscode/vsce

# 打包扩展（可选，用于测试打包后的版本）
vsce package

# 手动安装 .vsix 文件
code --install-extension git-merge-branch-to-1.2.2.vsix
```

### 方法三：使用 npx 打包（推荐，无需全局安装）

使用 `npx` 可以直接运行 `vsce`，无需全局安装：

```bash
# 使用 npx 打包扩展（无需全局安装 vsce）
npx @vscode/vsce package

# 打包完成后，手动安装 .vsix 文件
code --install-extension git-merge-branch-to-1.2.2.vsix
```

**优势**:
- ✅ 无需全局安装 `@vscode/vsce`
- ✅ 自动使用项目依赖中的版本（如果已安装）
- ✅ 避免全局依赖污染
- ✅ 更符合现代 Node.js 开发实践

**注意**: 如果项目 `package.json` 的 `devDependencies` 中已包含 `@vscode/vsce`，`npx` 会优先使用本地版本。

## ⚙️ 调试配置说明

项目已包含 `.vscode/launch.json` 配置文件，包含两个调试配置：

### 1. Run Extension（运行扩展）
```json
{
  "name": "Run Extension",
  "type": "extensionHost",
  "request": "launch",
  "args": [
    "--extensionDevelopmentPath=${workspaceFolder}"
  ]
}
```
- **用途**: 启动扩展开发模式
- **快捷键**: `F5`
- **说明**: 在新窗口中加载扩展，用于功能测试和调试

### 2. Extension Tests（扩展测试）
```json
{
  "name": "Extension Tests",
  "type": "extensionHost",
  "request": "launch",
  "args": [
    "--extensionDevelopmentPath=${workspaceFolder}",
    "--extensionTestsPath=${workspaceFolder}/test/suite/index"
  ]
}
```
- **用途**: 运行扩展的单元测试
- **说明**: 执行 `test/suite/` 目录下的测试用例

## 🧪 测试功能

### 1. 配置测试环境

在新打开的 Extension Development Host 窗口中：

1. **打开一个 Git 仓库**
   - 选择一个包含多个分支的 Git 项目

2. **配置扩展设置**
   - 打开设置（`Cmd+,` 或 `Ctrl+,`）
   - 搜索 "Git Merge Branch To"
   - 配置以下设置：
     ```json
     {
       "gitMergeBranchTo.branches": ["develop", "uat"],
       "gitMergeBranchTo.deployConfig": {
         "urlConfig": [
           {
             "env": "dev",
             "defaultBranch": "develop",
             "serverWebhookMap": {
               "your-project": {
                 "hookUrl": "http://your-webhook-url",
                 "webUrl": "https://your-pipeline-url"
               }
             }
           }
         ]
       },
       "gitMergeBranchTo.feishuId": "your-feishu-id"
     }
     ```

### 2. 测试分支合并

1. **切换到功能分支**
   ```bash
   git checkout feature/your-feature-branch
   ```

2. **执行合并命令**
   - 打开命令面板（`Cmd+Shift+P`）
   - 输入 "合并分支到指定分支"
   - 选择目标分支（如 `develop`）
   - 观察合并过程和结果

3. **检查调试输出**
   - 在原始调试窗口中查看 `console.log` 输出
   - 检查是否有错误信息

### 3. 运行单元测试

```bash
# 运行所有测试
npm test

# 或使用调试面板运行 "Extension Tests" 配置
```

## 🔍 调试技巧

### 1. 使用 console.log

在代码中添加调试输出：

```javascript
console.log('调试信息:', variableName);
console.error('错误信息:', error);
```

### 2. 使用 VS Code 调试控制台

- **查看输出**: 在调试控制台查看 `console.log` 输出
- **执行代码**: 在调试控制台直接执行 JavaScript 代码
- **查看变量**: 在变量面板查看当前作用域的变量值

### 3. 条件断点

- 右键点击断点，选择 "编辑断点"
- 设置条件表达式，例如：`targetBranch === 'develop'`
- 只有当条件满足时才会暂停

### 4. 日志断点

- 右键点击断点，选择 "添加日志点"
- 输入日志表达式，例如：`合并到分支: ${targetBranch}`
- 执行时会输出日志，但不会暂停执行

### 5. 调试 Git 命令

在 `extension.js` 中，Git 命令通过 `execSync` 执行。可以：

```javascript
// 添加调试输出
const gitCommand = `git -C "${repoPath}" worktree add --detach "${worktreePath}"`;
console.log('执行 Git 命令:', gitCommand);

try {
  execSync(gitCommand, {
    stdio: "pipe",
    maxBuffer: 1024 * 1024 * 10
  });
} catch (error) {
  console.error('Git 命令执行失败:', error.message);
  console.error('命令输出:', error.stdout?.toString());
  console.error('错误输出:', error.stderr?.toString());
}
```

## 🐛 常见问题

### 1. 扩展未加载

**问题**: 新窗口中看不到扩展功能

**解决方案**:
- 检查 `package.json` 中的 `activationEvents` 配置
- 确认命令名称是否正确注册
- 重新加载窗口：`Cmd+Shift+P` → "Reload Window"

### 2. 断点不生效

**问题**: 设置了断点但代码执行时不停下

**解决方案**:
- 确认代码已保存
- 确认断点设置在可执行代码行（不是注释或空行）
- 重新启动调试会话

### 3. Git 命令执行失败

**问题**: 合并操作失败

**解决方案**:
- 检查 Git 仓库状态
- 确认有足够的权限执行 Git 操作
- 查看调试控制台的错误信息
- 检查临时目录权限（`/tmp` 目录）

### 4. 内存占用过高

**问题**: 调试时 VS Code 内存占用过高

**解决方案**:
- 这是已知问题，已在 1.2.2 版本中修复
- 确保使用最新代码
- 如果仍有问题，检查 worktree 是否正确清理

### 5. 无法找到命令

**问题**: 命令面板中找不到 "合并分支到指定分支"

**解决方案**:
- 检查 `package.json` 中的 `contributes.commands` 配置
- 确认命令 ID 为 `gitMergeBranchTo.merge-branch-to`
- 重新加载扩展窗口

## 📝 调试检查清单

在提交代码前，确保：

- [ ] 代码已通过 ESLint 检查 (`npm run lint`)
- [ ] 所有断点已移除或注释
- [ ] 调试用的 `console.log` 已清理
- [ ] 功能在 Extension Development Host 中测试通过
- [ ] 单元测试通过 (`npm test`)
- [ ] 没有内存泄漏（检查任务管理器）
- [ ] Git 操作正常工作
- [ ] 错误处理正确

## 🔗 相关资源

- [VS Code Extension API 文档](https://code.visualstudio.com/api)
- [VS Code 调试文档](https://code.visualstudio.com/docs/editor/debugging)
- [Git Worktree 文档](https://git-scm.com/docs/git-worktree)
- [项目 README](./README.md)
- [变更日志](./CHANGELOG.md)

## 💡 提示

1. **使用两个窗口**: 一个用于编辑代码，一个用于测试扩展
2. **热重载**: 修改代码后，在 Extension Development Host 窗口中按 `Cmd+R` 重新加载
3. **查看日志**: 始终关注调试控制台的输出
4. **测试不同场景**: 测试正常流程、错误处理、边界情况
5. **使用 Git 测试仓库**: 创建一个专门的测试仓库，避免影响实际项目

---

**祝调试愉快！** 🎉

